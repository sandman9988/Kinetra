#!/bin/bash
# Pre-commit hook for Kinetra
# - Prevents direct commits to main
# - Validates against canonical rules
# - Backs up data before dangerous operations

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

branch=$(git branch --show-current)

echo "üîç Running pre-commit checks..."

# 1. Check branch protection
if [ "$branch" = "main" ]; then
    echo -e "${RED}‚ùå ERROR: Direct commits to main are not allowed!${NC}"
    echo ""
    echo "Please create a branch using:"
    echo "  git cb <ide> \"feature description\""
    echo ""
    echo "Example:"
    echo "  git cb claude \"fix authentication\""
    echo ""
    echo "Valid IDE prefixes: claude, copilot, cursor, windsurf, manual"
    exit 1
fi

# 2. Verify canonical rulebook exists
if [ ! -f "AGENT_RULES_MASTER.md" ]; then
    echo -e "${RED}‚ùå ERROR: Canonical rulebook AGENT_RULES_MASTER.md not found!${NC}"
    exit 1
fi

# 3. Check if data files are being committed (warn only)
data_files=$(git diff --cached --name-only | grep -E "^data/" || true)
if [ -n "$data_files" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: You are about to commit data files:${NC}"
    echo "$data_files"
    echo ""
    echo "Make sure these are intended and not large datasets."
    echo "Large files should be in .gitignore"
    # Don't exit, just warn
fi

# 4. Run rules linter on staged Python files
staged_python=$(git diff --cached --name-only --diff-filter=ACM | grep "\.py$" || true)
if [ -n "$staged_python" ]; then
    echo "üîç Linting staged Python files against canonical rules..."

    # Check if rules linter exists
    if [ -f "scripts/lint_rules.py" ]; then
        if ! python scripts/lint_rules.py $staged_python; then
            echo -e "${RED}‚ùå Rules validation failed!${NC}"
            echo "Fix violations or use 'git commit --no-verify' to skip (not recommended)"
            exit 1
        fi
        echo -e "${GREEN}‚úÖ Rules validation passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Rules linter not found, skipping validation${NC}"
    fi
fi

# 5. Check for hardcoded credentials in staged files
if git diff --cached | grep -E "(METAAPI_TOKEN|API_KEY|SECRET|PASSWORD)\s*=\s*[\"'][^\"']+[\"']" > /dev/null; then
    echo -e "${RED}‚ùå ERROR: Hardcoded credentials detected in staged changes!${NC}"
    echo "Use environment variables instead (.env file)"
    exit 1
fi

# 6. Check for traditional TA indicators in staged Python files
if [ -n "$staged_python" ]; then
    for file in $staged_python; do
        if grep -E "\b(RSI|MACD|Bollinger|ADX|Stochastic)\b" "$file" | grep -v "^#" | grep -v '"""' > /dev/null; then
            echo -e "${RED}‚ùå ERROR: Traditional TA indicator found in $file${NC}"
            echo "Use physics-based features only (see AGENT_RULES_MASTER.md)"
            exit 1
        fi
    done
fi

# 7. Backup data directory if it exists and has changes
if [ -d "data" ]; then
    data_changes=$(git diff --cached --name-only | grep "^data/" || true)
    if [ -n "$data_changes" ]; then
        echo "üíæ Creating backup of data directory..."
        if [ -f "scripts/backup_data.py" ]; then
            python scripts/backup_data.py --quiet || echo -e "${YELLOW}‚ö†Ô∏è  Backup failed (non-fatal)${NC}"
        else
            # Simple backup if script doesn't exist
            backup_dir="data/backups/pre-commit-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$backup_dir"
            cp -r data/* "$backup_dir/" 2>/dev/null || true
            echo -e "${GREEN}‚úÖ Backup created: $backup_dir${NC}"
        fi
    fi
fi

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
